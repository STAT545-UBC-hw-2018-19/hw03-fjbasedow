---
title: "STAT545 Homework 3"
author: "Frederike Basedow"
date: "26 September 2018"
output: github_document
---

```{r, message=FALSE}
library(tidyverse)
library(gapminder)
library(knitr)
library(reshape2)
```

### 1. Get the maximum and minimum of GDP per capita for all continents.

```{r}
range(gapminder$gdpPercap)

# calculate lowest and highest gdp per capita per continent
minmax_gdp_cont <- gapminder %>% 
  group_by(continent) %>% 
  summarize(Min = min(gdpPercap), Max = max(gdpPercap))

kable(minmax_gdp_cont)

# Plot of the highest and lowest value in GDP per Capita per continent
minmax_gdp_cont %>% 
  melt(variable.name="Statistic") %>% 
  ggplot(aes(continent,value, colour=Statistic)) + 
  geom_point() +
  labs(x="Continent", y="GDP per capita")


```

Looks like the gdp increased in every continent with time, although the change in Africa and the Americas in minimal.

Found the cool country colours through Jenny Brian's gapminder repo


### 2. Look at the spread of GDP per capita within the continents.

```{r}
# calculate spread statistics, i.e. standard deviation, interquartile range and median absolute deviation
spread_gdp_cont <- gapminder %>% 
  group_by(continent) %>% 
  summarize(SD = sd(gdpPercap), 
            IQR = IQR(gdpPercap), 
            MAD= mad(gdpPercap), 
            Mean = mean(gdpPercap))

kable(spread_gdp_cont)
```

Asia has the highest standard deviation, Europe the biggest interquartile range and median absolute deviation.

Here is a boxplot of the GDP per capita per continent to visualize the spread. Boxplots visualise the median, the lower and upper hinges correspond to the first and third quartiles and the length of the whiskers is 1.5x the IQR (from R documentation). Data beyond the whiskers are outliers and plotted as individual points. 
```{r}
# make boxplot that shows gdp per continent (log scale)
gapminder %>%  
  ggplot(aes(continent, gdpPercap)) +
  scale_y_log10() +
  geom_boxplot(outlier.color = "red") +
  labs(x="Continent", y="GDP per capita")
```

We can also make a bar graph with errorbars that represent the SD.

```{r}
gapminder %>% 
  ggplot() +
  scale_y_log10() +
  geom_bar(aes(continent, gdpPercap), stat= "summary", fun.y="mean")
```

```{r}
# make plot of how change of GDP per capita over the years in each continent
gapminder %>% 
  ggplot(aes(year, gdpPercap, colour=country, group=continent)) +
  scale_y_log10()+
  geom_jitter(show.legend=FALSE) +
  geom_smooth(method=lm, show.legend=FALSE) +
  facet_wrap(~continent) +
  labs(x="Year", y="GDP per capita") +
  scale_color_manual(values = country_colors)

```

Problem: cannot pipe gapminder into base R funtions `summary()` or `range`. This makes it hard to use these function for previously sorted data. Feel like my solution is very long and I am wondering if there is a shorter way to do this. Found summarize function in "data wrangling with tidyverse and dplyr" cheatsheet


### 3. Compute a trimmed mean of life expectancy for different years. Or a weighted mean, weighting by population. Just try something other than the plain vanilla mean.

```{r}
# calculate "vanilla" mean of life Exp
nm_lE <- mean(gapminder$lifeExp)
nm_lE

# calculate weighted mean for life Exp, weighing by population
wm_lE_pop <- weighted.mean(gapminder$lifeExp, gapminder$pop)
wm_lE_pop

# group gapminder data by year
gr_yrs <- gapminder %>% 
  group_by(year)

# calculate normal mean of life Exp per year
nm_lEy <- gr_yrs %>% 
  summarize(Mean=mean(lifeExp)) %>% 
  rename(Year=year)
kable(nm_lEy)

# calculate trimmed mean, by 30%, for each year
tm_lEy <- gr_yrs %>% 
  summarize(trMean=mean(lifeExp, trim=0.30)) %>% 
  rename(Year=year)
kable(tm_lEy)

# make matrix that includes both normal and trimmed mean for plotting
mns_lE <- (merge(tm_lEy, nm_lEy, by="Year")) %>% # combine normal mean and trimmed mean data
  column_to_rownames(var="Year") %>% # make years the rownames
  as.matrix() %>% # change to matrix for keeping years properly after melting
  melt(value.name = "Mean") %>% # combines Mean variables to one column with values and one column with respective labels
  rename(Year=Var1) %>% # change name of year column
  rename(trimmed=Var2) %>% # change column name of column that indicates if mean has bene trimmed
  mutate(trimmed = recode(trimmed, trMean="Yes", Mean="No")) # change level names of trimmed variable
head(mns_lE)

mns_lE %>% 
  ggplot(aes(Year, Mean, colour=trimmed)) +
  geom_point() +
  labs(x="Year", y="Mean")


```


### 4. How is life expectancy changing over time on different continents?

```{r}
gapminder %>% 
  ggplot(aes(year, lifeExp, colour=continent)) +
  geom_jitter() +
  geom_smooth(method=lm) +
  labs(x="Year", y="Life Expectancy") 

# show change of life expectancy over time for countries in each continent
gapminder %>% 
  ggplot(aes(year, lifeExp, colour=country, group=continent)) +
  geom_jitter(show.legend=FALSE) +
  geom_smooth(method=lm, show.legend=FALSE) +
  facet_wrap(~continent) +
  labs(x="Year", y="Life Expectancy") +
  scale_color_manual(values = country_colors)
```

### 5. Report the absolute and/or relative abundance of countries with low life expectancy over time by continent: Compute some measure of worldwide life expectancy – you decide – a mean or median or some other quantile or perhaps your current age. Then determine how many countries on each continent have a life expectancy less than this benchmark, for each year.

```{r}
# get mean life expectancy per year of countries with mean lifeExp lower than normal mean 
low_lE <- gapminder %>% 
  group_by(year, country, continent) %>% 
  summarize(mean=mean(lifeExp)) %>% 
  filter(mean < nm_lE) %>% 
  group_by(continent, year) %>% 
  summarize(num=n()) %>% 
  select(year, continent, num)

# other way
llE <- gr_yrs %>% filter(lifeExp < nm_lE) # this is not the mean, do i need the mean?
n_CbyY <-llE %>% 
  group_by(year, continent) %>% 
  count() %>% 
  arrange(continent)

low_lE == n_CbyY

# how many countries have a life expectancy less than nm_lE in general, not per year
summary(llE$continent) 

# same output, different way
llE %>% 
  group_by(continent) %>% 
  count()
```

```{r}
# lifeExp of country is < nm_lE for year x
# nlevels(continent) in year x for which lifeExp < nm_lE

# try loop option, something's wrong
lvl_cont <- levels(llE$continent)

for (i in 1:nlevels(llE$continent)){
  
  j <- llE %>%  
    count(lvl_cont[i]) 
  
  if (i < 2){
    k <- j
    }else{
      k<- bind_rows(k,j)  
    }
}

nc_llE <- k %>% 
  rename(continent=`lvl_cont[i]`) %>% 
  rename(n_countries=n)
# see lecture 8 to make this easier
nc_llE  # can I add the mean lifeExp per year per continent?




llE %>% 
  ggplot(aes(year, lifeExp, group=country, colour=country)) +
  geom_line(lwd=1, show.legend=FALSE) +
  geom_hline(yintercept = nm_lE) +
  facet_wrap(~continent) +
  scale_color_manual(values = country_colors) +
  labs(x="Year", y="Life Expectancy")

gapminder %>% 
  ggplot(aes(year, lifeExp, group=country, colour=country)) +
  geom_line(lwd=1, show.legend=FALSE) +
  geom_hline(yintercept = nm_lE) +
  facet_wrap(~continent) +
  scale_color_manual(values = country_colors) +
  labs(x="Year", y="Life Expectancy")
```

These plots shows the life expectancy over the years in different continents. Each line represents a country in the continent. The black line is the average life expectancy of all countries in all years.

### 6. Find countries with interesting stories. Open-ended and, therefore, hard. Promising but unsuccessful attempts are encouraged. This will generate interesting questions to follow up on in class.

It looks like there is a country in Afrika that had a big drop in life expectancy between 1987 and 1992. Let's figure out which country that is.
```{r}
gapminder %>% 
  group_by(country) %>% 
  mutate(drop = (lifeExp - lifeExp[year == 1987])) %>% 
  filter(continent == "Africa", year == 1992) %>% 
  summarize(Max = max(drop)) %>% 
  arrange(Max) 

Rwanda <- gapminder %>% filter(country == "Rwanda")

gapminder %>% 
  filter(continent== "Africa") %>% 
  ggplot(aes(year, lifeExp, group=country)) +
  geom_line(lwd=1, colour = "navy") +
  geom_line(data = Rwanda, aes(year, lifeExp), lwd=1, colour = "hotpink") +
  labs(x="Year", y="Life Expectancy")
```




Or, make up your own! Between the dplyr coverage in class and the list above, I think you get the idea.